{"version":3,"file":"pyorea.cjs","sources":["../src/pyorea.js"],"sourcesContent":["const defaultDeps = { react: \"18\", \"react-dom\": \"18\" };\n\nfunction delay(ms) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nasync function hidePreloader() {\n  const preloader = document.querySelector(\".preloader,.pyorea-preloader\");\n  if (preloader) {\n    preloader.style.transition = \"opacity 0.4s ease\";\n    preloader.style.opacity = 1;\n    preloader.style.opacity = 0;\n    await delay(410);\n    preloader.style.display = \"none\";\n  }\n}\n\n\n/**\n * \n * @param  {...string} paths \n */\n async function esmImport(...paths){\n    const modules =  await Promise.all(paths.map(p => import(`https://esm.sh/${p}`)));\n    if(modules.length===1){\n        return modules[0];\n    } else {\n        return modules\n    }\n  }\n\nwindow.esmImport = esmImport;\n\nasync function loadDeps() {\n  const allDeps = { ...defaultDeps, ...(window.npm_deps || {}) };\n  const depsLoadPromises = Promise.all(\n    Object.keys(allDeps).map((key) => {\n      const item = allDeps[key];\n      let version = \"\";\n      let name = item?.name || key.replace(/-/g, \"_\");\n      if (typeof item === \"string\") {\n        version = allDeps[key];\n      } else if (item?.version) {\n        version = allDeps[key]?.version;\n      }\n      return import(\n        `https://esm.sh/${key}${version ? `@${version}` : \"\"}`\n      ).then((module) => ({ module, name }));\n    })\n  );\n  const [moduleEntries] = await Promise.all([\n    depsLoadPromises,\n    import(\"https://cdn.jsdelivr.net/pyodide/v0.22.0/full/pyodide.js\"),\n  ]);\n\n  return moduleEntries;\n}\n\nconst libraryPythonCode = `\nimport inspect\nimport types\nimport sys\nfrom pyodide.ffi import create_proxy, to_js\nfrom js import window, document, Object\nimport react as React\nimport react_dom as ReactDOM\n\nflatten = lambda *n: (e for a in n\n                      for e in (flatten(*a) if isinstance(a, (tuple, list)) else (a,)))\n\n\n_h = React.createElement\n\n\ndef helper(type, *args):\n    props = None\n    children = []\n    if args and isinstance(args[0], dict):\n        props = to_js(args[0], dict_converter=Object.fromEntries)\n        if args[1:]:\n            children = flatten(args[1:])\n    elif args:\n        children = flatten(args)\n    return _h(type, props, *children)\n\n\nclass HyperScript(type):\n    def __getattribute__(self, __name):\n        def _helper(*args):\n            return helper(__name, *args)\n        return _helper\n\n    def __call__(self, type, *args):\n        return helper(type, *args)\n\n\nclass h(metaclass=HyperScript):\n    pass\n\n\ndef Component(component_fn):\n\n    def inner_fn(props, _opt):\n        func_params = (inspect.signature(component_fn).parameters)\n        return component_fn(props) if func_params else component_fn()\n\n    return create_proxy(inner_fn)\n\n\ndef render(app, selector):\n    root = ReactDOM.createRoot(document.querySelector(selector))\n    root.render(app)\n\n\n\npyorea = types.ModuleType('pyorea')\npyorea.h = h\npyorea.Component = Component\npyorea.render = render\npyorea.React = React\npyorea.esm_import = window.esmImport\nsys.modules['pyorea'] = pyorea\n\n`;\n\nasync function run() {\n  const moduleEntries = await loadDeps();\n  const pyodide = await loadPyodide({ fullStdLib: false });\n  window.__pyodide = pyodide;\n\n  for (const { module, name } of moduleEntries) {\n    pyodide.registerJsModule(name, module);\n  }\n  const scripts = [];\n  document\n    .querySelectorAll(`script[type=\"text/python\"]`)\n    .forEach((x, index) => {\n      if (x.src) {\n        scripts.push(\n          fetch(x.src)\n            .then((x) => x.text())\n            .then((text) => ({ text, name: x.src }))\n        );\n      } else {\n        scripts.push({\n          text: x.textContent,\n          name: `inline script #${index + 1}`,\n        });\n      }\n    });\n  let scriptContents = await Promise.all(scripts);\n  if (window.__scripts && Array.isArray(window.__scripts)) {\n    scriptContents = [...scriptContents, ...window.__scripts];\n  }\n  await hidePreloader();\n  \n  pyodide.runPython(libraryPythonCode);\n  for (const { text, name } of scriptContents) {\n    try {\n      await pyodide.loadPackagesFromImports(text);\n      await pyodide.runPythonAsync(text);\n    } catch (error) {\n      console.error(`Error in file ${name}`, error);\n    }\n  }\n}\n\nfunction main() {\n  window.addEventListener(\"DOMContentLoaded\", () => {\n    run().catch((e) => {\n      console.warn(\"load script error\", e);\n    });\n  });\n}\n\nmain();\n"],"names":["Symbol","iterator","_settle","pact","state","value","s","_Pact","o","bind","v","then","observer","prototype","onFulfilled","onRejected","result","this","callback","e","_this","_isSettledPact","thenable","defaultDeps","react","window","esmImport","_arguments2","arguments","Promise","resolve","all","map","p","modules","length","reject","addEventListener","allDeps","npm_deps","Object","keys","key","item","version","name","replace","_allDeps$key","module","depsLoadPromises","_interopNamespace","require","_ref","loadDeps","moduleEntries","loadPyodide","fullStdLib","pyodide","__pyodide","_step","_iterator","done","registerJsModule","_step$value","scripts","document","querySelectorAll","forEach","x","index","push","src","fetch","text","textContent","scriptContents","__scripts","Array","isArray","concat","hidePreloader","preloader","querySelector","_temp2","style","transition","opacity","display","runPython","target","body","check","_iteratorSymbol","step","_cycle","next","_fixup","values","i","array","_forTo","_forOf","_ref2","_temp3","recover","loadPackagesFromImports","runPythonAsync","_catch","error","console","warn"],"mappings":"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"}