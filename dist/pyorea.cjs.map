{"version":3,"file":"pyorea.cjs","sources":["../src/pyorea.js"],"sourcesContent":["const defaultDeps = { react: \"18\", \"react-dom\": \"18\" };\n\nfunction delay(ms) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nasync function hidePreloader() {\n  const preloader = document.querySelector(\".preloader\");\n  if (preloader) {\n    preloader.style.transition = \"opacity 0.4s ease\";\n    preloader.style.opacity = 1;\n    preloader.style.opacity = 0;\n    await delay(410);\n    preloader.style.display = \"none\";\n  }\n}\n\nasync function loadDeps() {\n\n  const allDeps = { ...defaultDeps, ...(window.npm_deps||{}) };\n  const depsLoadPromises = Promise.all(\n    Object.keys(allDeps).map((key) => {\n      const item = allDeps[key];\n      let version = \"\";\n      let name = item?.name || key.replace(/-/g, \"_\");\n      if (typeof item === \"string\") {\n        version = allDeps[key];\n      } else if (item?.version) {\n        version = allDeps[key]?.version;\n      }\n      return import(\n        `https://esm.sh/${key}${version ? `@${version}` : \"\"}`\n      ).then((module) => ({ module, name }));\n    })\n  );\n  const [moduleEntries] = await Promise.all([\n    depsLoadPromises,\n    import(\"https://cdn.jsdelivr.net/pyodide/v0.21.3/full/pyodide.js\"),\n  ]);\n\n  return moduleEntries;\n}\n\nconst libraryPythonCode = `\nimport inspect\nimport types\nimport sys\nfrom pyodide.ffi import create_proxy, to_js\nfrom js import window, document, Object\nimport react as React\nimport react_dom as ReactDOM\n\nflatten = lambda *n: (e for a in n\n                      for e in (flatten(*a) if isinstance(a, (tuple, list)) else (a,)))\n\n\n_h = React.createElement\n\n\ndef helper(type, *args):\n    props = None\n    children = []\n    if args and isinstance(args[0], dict):\n        props = to_js(args[0], dict_converter=Object.fromEntries)\n        if args[1:]:\n            children = flatten(args[1:])\n    elif args:\n        children = flatten(args)\n    return _h(type, props, *children)\n\n\nclass HyperScript(type):\n    def __getattribute__(self, __name):\n        def _helper(*args):\n            return helper(__name, *args)\n        return _helper\n\n    def __call__(self, type, *args):\n        return helper(type, *args)\n\n\nclass h(metaclass=HyperScript):\n    pass\n\n\ndef Component(component_fn):\n\n    def inner_fn(props, _opt):\n        func_params = (inspect.signature(component_fn).parameters)\n        return component_fn(props) if func_params else component_fn()\n\n    return create_proxy(inner_fn)\n\n\ndef render(app, selector):\n    root = ReactDOM.createRoot(document.querySelector(selector))\n    root.render(app)\n\n\n\npyorea = types.ModuleType('pyorea')\npyorea.h = h\npyorea.Component = Component\npyorea.render = render\npyorea.React = React\nsys.modules['pyorea'] = pyorea\n\n`\n\nasync function run() {\n  console.time(\"deps\");\n  const moduleEntries = await loadDeps();\n  console.timeEnd(\"deps\");\n  console.time(\"loadPy\");\n  const pyodide = await loadPyodide({ fullStdLib: true });\n  console.timeEnd(\"loadPy\");\n  console.time(\"register\");\n  for (const { module, name } of moduleEntries) {\n    pyodide.registerJsModule(name, module);\n  }\n  console.timeEnd(\"register\");\n  const scripts = [];\n  console.time(\"script1\");\n  document\n    .querySelectorAll(`script[type=\"text/python\"]`)\n    .forEach((x, index) => {\n      if (x.src) {\n        scripts.push(\n          fetch(x.src)\n            .then((x) => x.text())\n            .then((text) => ({ text, name: x.src }))\n        );\n      } else {\n        scripts.push({\n          text: x.textContent,\n          name: `inline script #${index + 1}`,\n        });\n      }\n    });\n  const scriptContents = await Promise.all(scripts);\n  console.log(\"scriptContecxt\", scriptContents);\n  console.timeEnd(\"script1\");\n  await hidePreloader();\n  console.time(\"script_ex\");\n  pyodide.runPython(libraryPythonCode);\n  for (const { text, name } of scriptContents) {\n    try {\n      pyodide.runPython(text);\n    } catch (error) {\n      console.error(`Error in file ${name}`, error);\n    }\n  }\n  console.timeEnd(\"script_ex\");\n}\n\nfunction main() {\n  window.addEventListener(\"DOMContentLoaded\", () => {\n    run().catch((e) => {\n      console.warn(\"load script error\", e);\n    });\n  });\n}\n\nmain();\n"],"names":["run","defaultDeps","react","window","addEventListener","console","time","Promise","resolve","loadDeps","allDeps","_extends","npm_deps","depsLoadPromises","all","Object","keys","map","key","t","item","version","name","replace","_allDeps$key","then","_interopNamespace","require","module","_ref","hidePreloader","moduleEntries","timeEnd","loadPyodide","fullStdLib","pyodide","_step","_iterator","done","_step$value","value","registerJsModule","scripts","document","querySelectorAll","forEach","x","index","push","src","fetch","text","textContent","scriptContents","log","preloader","querySelector","style","transition","opacity","display","_temp2","e","reject","runPython","_step2","_iterator2","_step2$value","error","warn"],"mappings":"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"}