{"version":3,"file":"pyorea.modern.js","sources":["../src/pyorea.js"],"sourcesContent":["const defaultDeps = { react: \"18\", \"react-dom\": \"18\" };\n\nfunction delay(ms) {\n  return new Promise((resolve) => setTimeout(resolve, ms));\n}\n\nasync function hidePreloader() {\n  const preloader = document.querySelector(\".preloader,.pyorea-preloader\");\n  if (preloader) {\n    preloader.style.transition = \"opacity 0.4s ease\";\n    preloader.style.opacity = 1;\n    preloader.style.opacity = 0;\n    await delay(410);\n    preloader.style.display = \"none\";\n  }\n}\n\n\n/**\n * \n * @param  {...string} paths \n */\n async function esmImport(...paths){\n    const modules =  await Promise.all(paths.map(p => import(`https://esm.sh/${p}`)));\n    if(modules.length===1){\n        return modules[0];\n    } else {\n        return modules\n    }\n  }\n\nwindow.esmImport = esmImport;\n\nasync function loadDeps() {\n  const allDeps = { ...defaultDeps, ...(window.npm_deps || {}) };\n  const depsLoadPromises = Promise.all(\n    Object.keys(allDeps).map((key) => {\n      const item = allDeps[key];\n      let version = \"\";\n      let name = item?.name || key.replace(/-/g, \"_\");\n      if (typeof item === \"string\") {\n        version = allDeps[key];\n      } else if (item?.version) {\n        version = allDeps[key]?.version;\n      }\n      return import(\n        `https://esm.sh/${key}${version ? `@${version}` : \"\"}`\n      ).then((module) => ({ module, name }));\n    })\n  );\n  const [moduleEntries] = await Promise.all([\n    depsLoadPromises,\n    import(\"https://cdn.jsdelivr.net/pyodide/v0.22.0/full/pyodide.js\"),\n  ]);\n\n  return moduleEntries;\n}\n\nconst libraryPythonCode = `\nimport inspect\nimport types\nimport sys\nfrom pyodide.ffi import create_proxy, to_js\nfrom js import window, document, Object\nimport react as React\nimport react_dom as ReactDOM\n\nflatten = lambda *n: (e for a in n\n                      for e in (flatten(*a) if isinstance(a, (tuple, list)) else (a,)))\n\n\n_h = React.createElement\n\n\ndef helper(type, *args):\n    props = None\n    children = []\n    if args and isinstance(args[0], dict):\n        props = to_js(args[0], dict_converter=Object.fromEntries)\n        if args[1:]:\n            children = flatten(args[1:])\n    elif args:\n        children = flatten(args)\n    return _h(type, props, *children)\n\n\nclass HyperScript(type):\n    def __getattribute__(self, __name):\n        def _helper(*args):\n            return helper(__name, *args)\n        return _helper\n\n    def __call__(self, type, *args):\n        return helper(type, *args)\n\n\nclass h(metaclass=HyperScript):\n    pass\n\n\ndef Component(component_fn):\n\n    def inner_fn(props, _opt):\n        func_params = (inspect.signature(component_fn).parameters)\n        return component_fn(props) if func_params else component_fn()\n\n    return create_proxy(inner_fn)\n\n\ndef render(app, selector):\n    root = ReactDOM.createRoot(document.querySelector(selector))\n    root.render(app)\n\n\n\npyorea = types.ModuleType('pyorea')\npyorea.h = h\npyorea.Component = Component\npyorea.render = render\npyorea.React = React\npyorea.esm_import = window.esmImport\nsys.modules['pyorea'] = pyorea\n\n`;\n\nasync function run() {\n  const moduleEntries = await loadDeps();\n  const pyodide = await loadPyodide({ fullStdLib: false });\n  window.__pyodide = pyodide;\n\n  for (const { module, name } of moduleEntries) {\n    pyodide.registerJsModule(name, module);\n  }\n  const scripts = [];\n  document\n    .querySelectorAll(`script[type=\"text/python\"]`)\n    .forEach((x, index) => {\n      if (x.src) {\n        scripts.push(\n          fetch(x.src)\n            .then((x) => x.text())\n            .then((text) => ({ text, name: x.src }))\n        );\n      } else {\n        scripts.push({\n          text: x.textContent,\n          name: `inline script #${index + 1}`,\n        });\n      }\n    });\n  let scriptContents = await Promise.all(scripts);\n  if (window.__scripts && Array.isArray(window.__scripts)) {\n    scriptContents = [...scriptContents, ...window.__scripts];\n  }\n  await hidePreloader();\n  \n  pyodide.runPython(libraryPythonCode);\n  for (const { text, name } of scriptContents) {\n    try {\n      await pyodide.loadPackagesFromImports(text);\n      await pyodide.runPythonAsync(text);\n    } catch (error) {\n      console.error(`Error in file ${name}`, error);\n    }\n  }\n}\n\nfunction main() {\n  window.addEventListener(\"DOMContentLoaded\", () => {\n    run().catch((e) => {\n      console.warn(\"load script error\", e);\n    });\n  });\n}\n\nmain();\n"],"names":["defaultDeps","react","window","esmImport","async","paths","modules","Promise","all","map","p","import","length","addEventListener","moduleEntries","allDeps","npm_deps","depsLoadPromises","Object","keys","key","item","version","name","replace","_allDeps$key","then","module","loadDeps","pyodide","loadPyodide","fullStdLib","__pyodide","registerJsModule","scripts","document","querySelectorAll","forEach","x","index","push","src","fetch","text","textContent","scriptContents","__scripts","Array","isArray","preloader","querySelector","style","transition","opacity","resolve","setTimeout","display","hidePreloader","runPython","loadPackagesFromImports","runPythonAsync","error","console","run","catch","e","warn"],"mappings":"oOAAA,MAAiBA,EAAG,CAAEC,MAAO,KAAM,YAAa,MA+BhDC,OAAOC,UATNC,kBAA4BC,GACzB,MAAaC,QAAiBC,QAACC,IAAIH,EAAMI,IAAIC,GAAKC,OAAQ,kBAAiBD,OAC3E,OAAoB,IAAjBJ,EAAQM,SACQ,GAGnBN,CACF,EA2IAJ,OAAOW,iBAAiB,mBAAoB,MA3C9CT,iBACE,MAAmBU,QA7FrBV,iBACE,MAAMW,EAAef,EAAAA,CAAAA,EAAAA,EAAiBE,OAAOc,UAAY,CAAE,GACrCC,EAAGV,QAAQC,IAC/BU,OAAOC,KAAKJ,GAASN,IAAKW,IACxB,MAAUC,EAAGN,EAAQK,GACrB,IAAIE,EAAU,MACC,MAAJD,OAAI,EAAJA,EAAME,OAAQH,EAAII,QAAQ,KAAM,KAC3C,GAAoB,iBAALH,EACbC,EAAUP,EAAQK,QACb,GAAQ,MAAJC,GAAAA,EAAMC,QAAS,CAAA,IAAAG,EACxBH,EAAsB,OAAfG,EAAGV,EAAQK,SAAI,EAAZK,EAAcH,OAC1B,CACA,OAAOX,OACJ,kBAAiBS,IAAME,EAAW,IAAGA,IAAY,MAClDI,KAAMC,IAAY,CAAEA,SAAQJ,SAAO,KAGlCT,SAAuBP,QAAQC,IAAI,CACxCS,EACAN,OAAO,8DAGT,OAAOG,CACT,CAsE8Bc,GACfC,QAASC,YAAY,CAAEC,YAAY,IAChD7B,OAAO8B,UAAYH,EAEnB,IAAK,MAAMF,OAAEA,EAAMJ,KAAEA,KAAUT,EAC7Be,EAAQI,iBAAiBV,EAAMI,GAEjC,MAAMO,EAAU,GAChBC,SACGC,iBAAkB,8BAClBC,QAAQ,CAACC,EAAGC,KAETL,EAAQM,KADNF,EAAEG,IAEFC,MAAMJ,EAAEG,KACLf,KAAMY,GAAMA,EAAEK,QACdjB,KAAMiB,IAAU,CAAEA,OAAMpB,KAAMe,EAAEG,OAGxB,CACXE,KAAML,EAAEM,YACRrB,KAAO,kBAAiBgB,EAAQ,KAEpC,GAEJ,IAAIM,QAA8BtC,QAACC,IAAI0B,GACnChC,OAAO4C,WAAaC,MAAMC,QAAQ9C,OAAO4C,aAC3CD,EAAiB,IAAIA,KAAmB3C,OAAO4C,kBAlJnD1C,iBACE,MAAM6C,EAAYd,SAASe,cAAc,gCACrCD,IACFA,EAAUE,MAAMC,WAAa,oBAC7BH,EAAUE,MAAME,QAAU,EAC1BJ,EAAUE,MAAME,QAAU,QARjB9C,IAAAA,QAAS+C,GAAYC,WAAWD,EAS7B,MACZL,EAAUE,MAAMK,QAAU,OAE9B,CA2IQC,GAEN5B,EAAQ6B,UAlGiB,6/CAmGzB,IAAK,MAAMf,KAAEA,EAAIpB,KAAEA,KAAwBsB,EACzC,UACQhB,EAAQ8B,wBAAwBhB,SAChCd,EAAQ+B,eAAejB,EAG/B,CAFE,MAAOkB,GACPC,QAAQD,MAAO,iBAAgBtC,IAAQsC,EACzC,CAEJ,EAIIE,GAAMC,MAAOC,IACXH,QAAQI,KAAK,oBAAqBD,EACpC,EACF"}